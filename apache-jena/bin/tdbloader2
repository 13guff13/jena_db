#!/bin/sh
## Licensed to the Apache Software Foundation (ASF) under one
## or more contributor license agreements.  See the NOTICE file
## distributed with this work for additional information
## regarding copyright ownership.  The ASF licenses this file
## to you under the Apache License, Version 2.0 (the
## "License"); you may not use this file except in compliance
## with the License.  You may obtain a copy of the License at
##
##     http://www.apache.org/licenses/LICENSE-2.0
##
## Unless required by applicable law or agreed to in writing, software
## distributed under the License is distributed on an "AS IS" BASIS,
## WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
## See the License for the specific language governing permissions and
## limitations under the License.

function printUsage() {
  cat << EOF
Usage: tdbloader2 <Options> <Data>

Options are as follows:

  --help
    Prints this help summary and exits

  --loc <DatabaseDirectory>
    Sets the location in which the database should be created

  --phase <Phase>
    Sets the phase of the build to run, supported values are:

      all    Full bulk load
      data   Data phase only
      index  Index phase only, requires the data phase to previously have been run

    When not specified defaults to all

EOF
}

# If JENA_HOME is empty
if [ -z "$JENA_HOME" ]
	then
    SCRIPT="$0"
    # Catch common issue: script has been symlinked
	if [ -L "$SCRIPT" ]
		then
		SCRIPT="$(readlink "$0")"
		# If link is relative
		case "$SCRIPT" in
   			/*) ;; # fine
			*) SCRIPT=$( dirname "$0" )/$SCRIPT;; # fix
		esac
	fi

    # Work out root from script location
    JENA_HOME="$( cd "$( dirname "$SCRIPT" )/.." && pwd )"
fi

# ---- Setup
JVM_ARGS=${JVM_ARGS:--Xmx1024M}
# Expand JENA_HOME but literal *
JENA_CP="$JENA_HOME"'/lib/*'
SOCKS=
LOGGING="-Dlog4j.configuration=file:$JENA_HOME/jena-log4j.properties"

# Platform specific fixup
#??On CYGWIN convert path and end with a ';' 
case "$(uname)" in
   CYGWIN*) JENA_CP="$(cygpath -wp "$JENA_CP");";;
esac

export JENA_CP
#echo $JENA_CP
if [ -z "$SORT_ARGS" ]
then
    SORT_ARGS="--buffer-size=50%"
    if $(sort --parallel=3 < /dev/null 2>/dev/null) 
    then
	SORT_ARGS="$SORT_ARGS --parallel=3"
    fi
fi
export SORT_ARGS

# Process arguments
LOC=
PHASE=

while [ $# -gt 0 ]
do
  ARG=$1
  case "$ARG" in
    --loc|-loc)
      # Location space separated
      shift
      LOC="$1"
      shift
      ;;
    -*loc=*)
      # Location = separated
      LOC=${ARG/-*loc=/}
      shift
      ;;
    --phase)
      # Phase space separated
      shift
      PHASE="$1"
      shift
      ;;
    --help)
      # Help
      printUsage
      exit 0
      ;;
    *)
      # Once we see an unrecognized argument treat as start of files to process
      break
      ;;
  esac
done

if [ -z "$PHASE" ]; then
  PHASE="all"
fi

#echo "Location is '$LOC'"
#echo "Phase is '$PHASE'"

log() { echo " $(date $DATE)" "$@" ; }

#DATE="+%Y-%m-%dT%H:%M:%S%:z"
DATE="+%H:%M:%S"

# ---- Start
log "-- TDB Bulk Loader Start"
TIME1="$(date +%s)"

case "$PHASE" in
  all)
    exec "$JENA_HOME/bin/tdbloader2data" --loc "$LOC" "$@"
    exec "$JENA_HOME/bin/tdbloader2index" --loc "$LOC"
    ;;
  data)
    exec "$JENA_HOME/bin/tdbloader2data" --loc "$LOC" "$@"
    ;;
  index)
    exec "$JENA_HOME/bin/tdbloader2index" --loc "$LOC"
    ;;
  *)
    echo "Unrecognized phase $PHASE" 1>&2
    exit 1
    ;;
esac

# ---- End
TIME2="$(date +%s)"
log "-- TDB Bulk Loader Finish"
ELAPSED=$(($TIME2-$TIME1))
log "-- $ELAPSED seconds"